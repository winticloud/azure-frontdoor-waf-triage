{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Front Door WAF Triage",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "variables": {
    "workbookContent": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 1,
          "content": {
            "json": "## Front Door WAF Triage Workbook\n---\n\nThis workbook helps you triage Azure Front Door WAF violations."
          },
          "name": "text - 2"
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "63ea93e5-3270-4447-9572-ad9e62095e7b",
                "version": "KqlParameterItem/1.0",
                "name": "subscription",
                "label": "Subscription",
                "type": 6,
                "isRequired": true,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "value": [ "all" ],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "includeAll": false
                }
              },
              {
                "id": "12476248-81b7-46af-a9b4-790f93306442",
                "version": "KqlParameterItem/1.0",
                "name": "workspace",
                "label": "Workspace",
                "type": 5,
                "isRequired": true,
                "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by id, name\r\n| project id",
                "crossComponentResources": [ "{subscription}" ],
                "value": "all",
                "typeSettings": { "additionalResourceOptions": [] },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              },
              {
                "id": "f451ddc5-00e3-4fe7-908e-22d0be9ab59c",
                "version": "KqlParameterItem/1.0",
                "name": "detectionTime",
                "label": "Detection Time",
                "type": 4,
                "isRequired": true,
                "value": { "durationMs": 14400000 },
                "typeSettings": {
                  "selectableValues": [
                    { "durationMs": 300000 }, { "durationMs": 900000 },
                    { "durationMs": 1800000 }, { "durationMs": 3600000 },
                    { "durationMs": 14400000 }, { "durationMs": 43200000 },
                    { "durationMs": 86400000 }, { "durationMs": 172800000 },
                    { "durationMs": 259200000 }, { "durationMs": 604800000 },
                    { "durationMs": 1209600000 }, { "durationMs": 2419200000 },
                    { "durationMs": 2592000000 }, { "durationMs": 5184000000 },
                    { "durationMs": 7776000000 }
                  ]
                },
                "timeContext": { "durationMs": 86400000 }
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "name": "parameters - 2"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "AzureDiagnostics \n| where Category == \"FrontDoorWebApplicationFirewallLog\"\n| where TimeGenerated {detectionTime}\n| extend policy_s = column_ifexists(\"policy_s\", \"\")\n| extend action_s = column_ifexists(\"action_s\", \"\")\n| evaluate pivot(action_s, count(), ResourceId, policy_s)",
            "size": 1,
            "title": "Select the scope of the WAF policy",
            "exportedParameters": [
              {
                "fieldName": "policy_s",
                "parameterName": "PolicyScope",
                "parameterType": 1
              },
              {
                "fieldName": "ResourceId",
                "parameterName": "ResourceId",
                "parameterType": 1
              }
            ],
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [ "{workspace}" ],
            "visualization": "table",
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "$gen_group",
                  "formatter": 13,
                  "formatOptions": { "linkTarget": null, "showIcon": true }
                },
                { "columnMatch": "ResourceId", "formatter": 5 },
                { "columnMatch": "AnomalyScoring", "formatter": 8, "formatOptions": { "palette": "greenRed" } },
                { "columnMatch": "Log", "formatter": 8, "formatOptions": { "palette": "greenRed" } },
                { "columnMatch": "Block", "formatter": 8, "formatOptions": { "palette": "greenRed" } }
              ],
              "rowLimit": 500,
              "hierarchySettings": {
                "treeType": 1,
                "groupBy": [ "ResourceId" ]
              },
              "labelSettings": [
                { "columnId": "ResourceId", "label": "Front Door" },
                { "columnId": "policy_s", "label": "WAF Policy" }
              ]
            },
            "tileSettings": { "showBorder": false }
          },
          "name": "query-frontdoor-resources"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "tabs",
            "links": [
              {
                "id": "14e61d36-d59a-405d-8363-ac1aa8a2f491",
                "cellValue": "SelectedTabPage",
                "linkTarget": "parameter",
                "linkLabel": "Triage by Rule",
                "subTarget": "triage-by-rule",
                "preText": "Triage by Rule",
                "style": "link"
              },
              {
                "id": "93464fc4-d183-4d74-9e06-111c6de081a9",
                "cellValue": "SelectedTabPage",
                "linkTarget": "parameter",
                "linkLabel": "Triage by URL",
                "subTarget": "triage-by-url",
                "preText": "Triage ",
                "style": "link"
              }
            ]
          },
          "name": "TabNavigation"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where TimeGenerated {detectionTime}\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}'\r\n| summarize Count = count() by ruleName_s, action_s\r\n| order by Count desc\r\n| project-reorder Count\r\n// add sparklines\r\n| join kind=inner (\r\n    AzureDiagnostics\r\n    | where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n    | where TimeGenerated {detectionTime}\r\n    | where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}'\r\n    | make-series Trend = count() on TimeGenerated from {detectionTime:start} to {detectionTime:end} step (time({detectionTime:seconds} seconds) / 20) by ruleName_s\r\n  ) on ruleName_s\r\n| extend Id = new_guid()",
                  "size": 0,
                  "showAnalytics": true,
                  "title": "Rules that got triggered",
                  "exportedParameters": [
                    { "fieldName": "ruleName_s", "parameterName": "RuleId" }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "gridSettings": {
                    "formatters": [
                      { "columnMatch": "Count", "formatter": 8, "formatOptions": { "palette": "greenRed" } },
                      { "columnMatch": "Trend", "formatter": 10, "formatOptions": { "palette": "yellowOrangeRed" } },
                      { "columnMatch": "TimeGenerated", "formatter": 5 },
                      { "columnMatch": "Id", "formatter": 5 },
                      { "columnMatch": "ruleName_s1", "formatter": 5 }
                    ],
                    "sortBy": [ { "itemKey": "$gen_heatmap_Count_0", "sortOrder": 2 } ],
                    "labelSettings": [
                      { "columnId": "ruleName_s", "label": "Rule Name" },
                      { "columnId": "action_s", "label": "Action" }
                    ]
                  },
                  "sortBy": [ { "itemKey": "$gen_heatmap_Count_0", "sortOrder": 2 } ]
                },
                "customWidth": "100",
                "name": "query - violated rules"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}' and ruleName_s == '{RuleId}'\r\n| where TimeGenerated {detectionTime}\r\n| distinct host_s",
                  "size": 0,
                  "title": "Hosts Affected",
                  "exportedParameters": [
                    { "fieldName": "host_s", "parameterName": "HostName" },
                    { "fieldName": "host_s", "parameterName": "HostNameNoPort", "parameterType": 1 }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "visualization": "table",
                  "gridSettings": {
                    "labelSettings": [ { "columnId": "host_s", "label": "Hostname" } ]
                  }
                },
                "customWidth": "15",
                "showPin": true,
                "name": "Affected Hosts"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where TimeGenerated {detectionTime}\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}' and ruleName_s == '{RuleId}'\r\n| where host_s == '{HostName}'\r\n| project trackingReference_s\r\n| join kind=inner (\r\n    AzureDiagnostics\r\n    | where Category == \"FrontDoorAccessLog\"\r\n    | where TimeGenerated {detectionTime}\r\n  ) on trackingReference_s\r\n| distinct hostName_s, httpMethod_s, requestUri_s\r\n| order by hostName_s, requestUri_s, httpMethod_s\r\n| extend id = new_guid()",
                  "size": 0,
                  "showAnalytics": true,
                  "title": "Hosts and urls impacted by selected rule",
                  "exportedParameters": [
                    { "fieldName": "httpMethod_s", "parameterName": "Method", "parameterType": 1 },
                    { "fieldName": "requestUri_s", "parameterName": "FullUri", "parameterType": 1 },
                    { "fieldName": "requestUri_s", "parameterName": "RequestUri", "parameterType": 1 }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "visualization": "table",
                  "gridSettings": {
                    "formatters": [ { "columnMatch": "id", "formatter": 5 } ],
                    "rowLimit": 1000,
                    "hierarchySettings": {
                      "treeType": 1,
                      "groupBy": [ "hostName_s", "httpMethod_s" ],
                      "expandTopLevel": true,
                      "finalBy": "requestUri_s"
                    },
                    "labelSettings": [
                      { "columnId": "hostName_s", "label": "Host" },
                      { "columnId": "httpMethod_s", "label": "Method" },
                      { "columnId": "requestUri_s", "label": "Request URI" }
                    ]
                  }
                },
                "customWidth": "60",
                "name": "affected urls"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}'\r\n| where TimeGenerated {detectionTime}\r\n| distinct trackingReference_s\r\n| join kind=inner (\r\n    AzureDiagnostics\r\n    | where Category == \"FrontDoorAccessLog\"\r\n    | where TimeGenerated {detectionTime}\r\n  ) on trackingReference_s\r\n| where hostName_s == '{HostNameNoPort}' and httpMethod_s == '{Method}' and requestUri_s == ```{FullUri}```\r\n| project trackingReference_s\r\n| extend access_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorAccessLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")\r\n| extend firewall_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorWebApplicationFirewallLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")",
                  "size": 0,
                  "title": "Requests on selected host and url",
                  "exportFieldName": "trackingReference_s",
                  "exportParameterName": "TransactionId",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "gridSettings": {
                    "formatters": [
                      { "columnMatch": "trackingReference_s", "formatter": 0, "formatOptions": { "customColumnWidthSetting": "40%" } },
                      {
                        "columnMatch": "access_log",
                        "formatter": 7,
                        "formatOptions": {
                          "linkTarget": "OpenBlade", "linkLabel": "Find in Access Log", "linkIsContextBlade": true,
                          "bladeOpenContext": {
                            "bladeName": "LogsBlade", "extensionName": "Microsoft_Azure_Monitoring_Logs",
                            "bladeParameters": [
                              { "name": "resourceId", "source": "parameter", "value": "workspace" },
                              { "name": "source", "source": "static", "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade" },
                              { "name": "query", "source": "cell", "value": "" }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "firewall_log",
                        "formatter": 7,
                        "formatOptions": {
                          "linkTarget": "OpenBlade", "linkLabel": "Find in Firewall Log", "linkIsContextBlade": true,
                          "bladeOpenContext": {
                            "bladeName": "LogsBlade", "extensionName": "Microsoft_Azure_Monitoring_Logs",
                            "bladeParameters": [
                              { "name": "resourceId", "source": "parameter", "value": "workspace" },
                              { "name": "source", "source": "static", "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade" },
                              { "name": "query", "source": "cell", "value": "" }
                            ]
                          }
                        }
                      }
                    ]
                  }
                },
                "customWidth": "25",
                "name": "ImpactedRequestsFromSelectedUri"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where trackingReference_s == '{TransactionId}'\r\n| project action_s, ruleName_s, host_s, requestUri_s, clientIP_s, TimeGenerated",
                  "size": 0,
                  "title": "Rules that got triggered for selected request",
                  "exportedParameters": [
                    { "fieldName": "trackingReference_s", "parameterName": "TransactionId" },
                    { "fieldName": "ruleName_s", "parameterName": "message", "parameterType": 1 }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "visualization": "table",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "action_s",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            { "operator": "==", "thresholdValue": "Log", "representation": "2", "text": "{0}{1}" },
                            { "operator": "==", "thresholdValue": "Block", "representation": "4", "text": "{0}{1}" },
                            { "operator": "Default", "thresholdValue": null, "representation": "more", "text": "{0}{1}" }
                          ]
                        }
                      },
                      {
                        "columnMatch": "ruleName_s",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            { "operator": "==", "thresholdValue": "{RuleId}", "representation": "yellow", "text": "{0}{1}" },
                            { "operator": "Default", "thresholdValue": null, "text": "{0}{1}" }
                          ]
                        }
                      }
                    ],
                    "labelSettings": [
                      { "columnId": "action_s", "label": "action" },
                      { "columnId": "ruleName_s", "label": "rule name" },
                      { "columnId": "host_s", "label": "host" },
                      { "columnId": "requestUri_s", "label": "request URI" },
                      { "columnId": "clientIP_s", "label": "client IP" },
                      { "columnId": "TimeGenerated", "label": "time generated" }
                    ]
                  }
                },
                "name": "TriggeredRules"
              },
              {
                "type": 1,
                "content": {
                  "json": "## Selection Summary:\r\n\r\nYou were looking for example requests which were impacted by WAF rule: **{RuleId}**.  \r\n\r\nOn the host \"*{HostName}*\" and url \"*{FullUri}*\" you have found an HTTP request impacted by this rule, with tracking reference equal to *{TransactionId}*.  \r\n\r\nMore info on this request and the selected rule:\r\n- Rule: {message}"
                },
                "name": "text - 7"
              }
            ],
            "exportParameters": true
          },
          "conditionalVisibility": {
            "parameterName": "SelectedTabPage",
            "comparison": "isEqualTo",
            "value": "triage-by-rule"
          },
          "name": "Triage by rule"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}'\r\n| where TimeGenerated {detectionTime}\r\n| distinct host_s",
                  "size": 0,
                  "title": "Hostnames with entries in Firewall Log",
                  "exportFieldName": "host_s",
                  "exportParameterName": "HostName",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "gridSettings": {
                    "formatters": [
                      { "columnMatch": "host_s", "formatter": 0, "formatOptions": { "customColumnWidthSetting": "100%" } }
                    ],
                    "sortBy": [ { "itemKey": "host_s", "sortOrder": 1 } ]
                  },
                  "sortBy": [ { "itemKey": "host_s", "sortOrder": 1 } ]
                },
                "customWidth": "10",
                "name": "Hostnames with entries in Firewall Log"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}'\r\n| where host_s == '{HostName}'\r\n| where TimeGenerated {detectionTime}\r\n| join kind=inner (\r\n    AzureDiagnostics\r\n    | where Category == \"FrontDoorAccessLog\"\r\n    | where ResourceId == '{ResourceId}'\r\n  ) on trackingReference_s\r\n| distinct requestUri_s1, httpMethod_s, httpStatusCode_s\r\n| extend Id = new_guid()\r\n",
                  "size": 0,
                  "title": "Paths which have triggered firewall rules",
                  "exportedParameters": [
                    { "fieldName": "requestUri_s1", "parameterName": "RequestUri" },
                    { "fieldName": "requestUri_s1", "parameterName": "RequestUriWithArgs", "parameterType": 1 },
                    { "fieldName": "httpMethod_s", "parameterName": "HttpMethod", "parameterType": 1 },
                    { "fieldName": "httpStatusCode_s", "parameterName": "HttpStatus", "parameterType": 1 },
                    { "parameterType": 1 }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "gridSettings": {
                    "formatters": [ { "columnMatch": "Id", "formatter": 5 } ],
                    "filter": true,
                    "hierarchySettings": {
                      "treeType": 1,
                      "groupBy": [ "requestUri_s1", "httpMethod_s" ],
                      "finalBy": "httpStatusCode_s"
                    },
                    "sortBy": [ { "itemKey": "httpStatusCode_s", "sortOrder": 1 } ],
                    "labelSettings": [
                      { "columnId": "requestUri_s1", "label": "Request URI" },
                      { "columnId": "httpMethod_s", "label": "Method" },
                      { "columnId": "httpStatusCode_s", "label": "HTTP Status" }
                    ]
                  },
                  "sortBy": [ { "itemKey": "httpStatusCode_s", "sortOrder": 1 } ]
                },
                "customWidth": "60",
                "name": "Paths which have triggered firewall rules"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}' and policy_s == '{PolicyScope}'\r\n| where host_s == '{HostName}'\r\n| where TimeGenerated {detectionTime}\r\n| join kind=inner (\r\n    AzureDiagnostics\r\n    | where Category == \"FrontDoorAccessLog\"\r\n    | where ResourceId == '{ResourceId}'\r\n  ) on trackingReference_s\r\n| where requestUri_s1 == ```{RequestUriWithArgs}``` and httpMethod_s == '{HttpMethod}'\r\n| distinct trackingReference_s\r\n| extend access_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorAccessLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")\r\n| extend firewall_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorWebApplicationFirewallLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")",
                  "size": 0,
                  "title": "Requests on selected host and url",
                  "exportFieldName": "trackingReference_s",
                  "exportParameterName": "TransactionId",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "gridSettings": {
                    "formatters": [
                      { "columnMatch": "trackingReference_s", "formatter": 0, "formatOptions": { "customColumnWidthSetting": "40%" } },
                      {
                        "columnMatch": "access_log",
                        "formatter": 7,
                        "formatOptions": {
                          "linkTarget": "OpenBlade", "linkLabel": "Find in Access Log", "linkIsContextBlade": true,
                          "bladeOpenContext": {
                            "bladeName": "LogsBlade", "extensionName": "Microsoft_Azure_Monitoring_Logs",
                            "bladeParameters": [
                              { "name": "resourceId", "source": "parameter", "value": "workspace" },
                              { "name": "source", "source": "static", "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade" },
                              { "name": "query", "source": "cell", "value": "" }
                            ]
                          }
                        }
                      },
                      {
                        "columnMatch": "firewall_log",
                        "formatter": 7,
                        "formatOptions": {
                          "linkTarget": "OpenBlade", "linkLabel": "Find in Firewall Log", "linkIsContextBlade": true,
                          "bladeOpenContext": {
                            "bladeName": "LogsBlade", "extensionName": "Microsoft_Azure_Monitoring_Logs",
                            "bladeParameters": [
                              { "name": "resourceId", "source": "parameter", "value": "workspace" },
                              { "name": "source", "source": "static", "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade" },
                              { "name": "query", "source": "cell", "value": "" }
                            ]
                          }
                        }
                      }
                    ]
                  }
                },
                "customWidth": "25",
                "name": "query - 3"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where trackingReference_s == '{TransactionId}'\r\n| project action_s, ruleName_s, host_s, requestUri_s, clientIP_s, TimeGenerated",
                  "size": 0,
                  "title": "Rules that got triggered for selected request",
                  "exportedParameters": [
                    { "fieldName": "trackingReference_s", "parameterName": "TransactionId" },
                    { "fieldName": "ruleName_s", "parameterName": "message", "parameterType": 1 }
                  ],
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [ "{workspace}" ],
                  "visualization": "table",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "action_s",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            { "operator": "==", "thresholdValue": "Log", "representation": "2", "text": "{0}{1}" },
                            { "operator": "==", "thresholdValue": "Block", "representation": "4", "text": "{0}{1}" },
                            { "operator": "Default", "thresholdValue": null, "representation": "more", "text": "{0}{1}" }
                          ]
                        }
                      },
                      {
                        "columnMatch": "ruleName_s",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "colors",
                          "thresholdsGrid": [
                            { "operator": "==", "thresholdValue": "{RuleId}", "representation": "yellow", "text": "{0}{1}" },
                            { "operator": "Default", "thresholdValue": null, "text": "{0}{1}" }
                          ]
                        }
                      }
                    ],
                    "labelSettings": [
                      { "columnId": "action_s", "label": "action" },
                      { "columnId": "ruleName_s", "label": "rule name" },
                      { "columnId": "host_s", "label": "host" },
                      { "columnId": "requestUri_s", "label": "request URI" },
                      { "columnId": "clientIP_s", "label": "client IP" },
                      { "columnId": "TimeGenerated", "label": "time generated" }
                    ]
                  }
                },
                "name": "TriggeredRules - By Url"
              },
              {
                "type": 1,
                "content": {
                  "json": "## Selection Summary:\r\n\r\nYou were looking for requests which triggered a WAF rule on url: _{RequestUri}_.  \r\nYou have found an HTTP request impacted by this rule, with tracking reference equal to *{TransactionId}*.  \r\n\r\nMore info on this request and the selected rule:\r\n- Rule: {message}"
                },
                "name": "text - 7 - Copy"
              }
            ],
            "exportParameters": true
          },
          "conditionalVisibility": {
            "parameterName": "SelectedTabPage",
            "comparison": "isEqualTo",
            "value": "triage-by-url"
          },
          "name": "Triage by URL"
        }
      ],
      "isLocked": false,
      "defaultResourceIds": [ "value::all" ]
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}
